### 抽奖

> index.js

```js
// packageteseE/pages/jiaxing_qa/start-lottery/index.js
const obj = require('../../../../utils/util')
const app = getApp()

let timer = null 	// 抽奖定时器
let winningTimer = null	// 小喇叭定时器

Page({
  
  /**
   * 页面的初始数据
   */
  data: {
    dataList: [],		// 奖品列表
    isExChange: false,	// 是否兑换
    chanceCount: 0,		// 抽奖次数
    
    isStart: false,		// 是否已经开始抽奖
    result: 0,			// 默认没中奖
    lotteryResult: {},	// 抽奖结果
    isResult: false,	// 是否显示结果
    isBingo: false,		// 是否中奖
    
    winningName: '',
    winningPrize: ''
  },
  
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    wx.hideShareMenu()
    this.fetchPrizeList()
    this.fetchWinningList()
  },
  
  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload() {
    if (timer) {
      clearInterval(timer)
    }
    if (winningTimer) {
      clearInterval(winningTimer)
    }
  },
  // 获取中奖名单
  fetchWinningList() {
    const { openid, avatar, nickname } = app.globalData.userInfo
    obj.wxRequest({
      url: 'answerlotto/lucklist',
      data: {
        openid: openid,
        avatar: avatar,
        nickname: nickname
      }
    }).then(res => {
      const { code, data } = res.data
      // console.log(data)
      if (code > 0) {
        if (data) {
          let dataLen = data.length
          let index = 1
          
          this.setData({
            winningName: data[0].nickname,
            winningPrize: data[0].prize_longname
          })
          
          winningTimer = setInterval(() => {
            index += 1
            if (index === dataLen) {
              index = 0
            }
            this.setData({
              winningName: data[index].nickname,
              winningPrize: data[index].prize_longname
            })
            // console.log(this.data.winningName, this.data.winningPrize)
          }, 3000)
        }
      }
    })
  },
  // 获取用户抽奖机会
  fetchUserChanceCount() {
    const { openid, avatar, nickname } = app.globalData.userInfo
    wx.showLoading({
      title: '加载中...',
      mask: true
    })
    obj.wxRequest({
      url: 'answerlotto/getchance',
      data: {
        openid: openid,
        avatar: avatar,
        nickname: nickname
      }
    }).then(res => {
      wx.hideLoading()
      const { code, data } = res.data
      console.log(data)
      if (code > 0) {
        if (data) {
          this.setData({
            chanceCount: data.chance
          })
        }
      }
    })
  },
  // 获取奖品列表
  fetchPrizeList() {
    const { openid, avatar, nickname } = app.globalData.userInfo
    wx.showLoading({
      title: '加载中...',
      mask: true
    })
    obj.wxRequest({
      url: 'answerlotto/lottolist',
      data: {
        openid: openid,
        avatar: avatar,
        nickname: nickname
      }
    }).then(res => {
      wx.hideLoading()
      const { code, data } = res.data
      if (code > 0) {
        if (data) {
          data.forEach(item => {
            item.isSelected = false
          })
          this.setData({
            dataList: data,
            prizeIdList: this.data.prizeIdList
          })
          console.log(this.data.dataList)
          this.fetchUserChanceCount()
        }
      }
    })
  },
  // 抽奖操作
  handleClickStartLottery() {
    console.log('初始化')
    this.init()
    if (this.data.chanceCount === 0) {
      wx.showModal({
        title: '提示',
        content: '答对题目才能抽奖哦~',
        confirmText: '立即答题',
        success(res) {
          if (res.confirm) {
            wx.navigateTo({
              url: '/packageteseE/pages/jiaxing_qa/answering/index'
            })
          }
        }
      })
      return
    }
    
    console.log('开始抽奖')
    const { openid, avatar, nickname } = app.globalData.userInfo
    
    if (this.data.isStart) {
      console.log('正在抽奖')
      return
    }
    this.setData({ isStart: true })
    
    wx.showLoading({
      title: '加载中...',
      mask: true
    })
    // 减去次数
    obj.wxRequest({
      url: 'answerlotto/chancedeal',
      data: {
        openid: openid,
        avatar: avatar,
        nickname: nickname,
        status: 'minus'
      }
    }).then(res => {
      wx.hideLoading()
      const { code, data } = res.data
      console.log(res.data)
      if (code > 0) {
        this.setData({
          chanceCount: data.chance_count
        })
        // 返回抽奖结果
        wx.showLoading({
          title: '加载中...',
          mask: true
        })
        obj.wxRequest({
          url: 'answerlotto/rand_select',
          data: {
            openid: openid,
            avatar: avatar,
            nickname: nickname
          }
        }).then(res => {
          wx.hideLoading()
          const { code, data } = res.data
          if (code > 0) {
            if (data) {
              console.log(data)
              this.setData({
                lotteryResult: data
              })
              this.startLottery()		// 执行抽奖
            }
          }
        })
      }
    })
  },
  // 开始抽奖
  startLottery() {
    let roundNum = 5	// 圈数
    let speed = 100		// 旋转速度
    this.loop(0, roundNum, speed)
  },
  // 初始化样式
  init() {
    this.data.dataList.forEach(item => {
      item.isSelected = false
    })
    this.setData({
      dataList: this.data.dataList
    })
  },
  // 循环转圈
  loop(index, roundNum, speed) {
    let currentIndex
    let oldCurrentIndex
    
    // 清除上一个样式
    if (index > 0) {
      oldCurrentIndex = `dataList[${index - 1}].isSelected`
      this.setData({
        [oldCurrentIndex]: false
      })
    }
    
    // 初始化循环
    if (index === 8) {
      index = 0
      roundNum -= 1
    }
    currentIndex = `dataList[${index}].isSelected`
    this.setData({
      [currentIndex]: true
    })
    
    // 停止动画 最后一圈判断结果
    if (roundNum === 1) {
      // console.log('低速', index, roundNum)
      const { dataList, lotteryResult } = this.data
      let resultIndex = dataList.findIndex((item) => {
        if (item.id === this.data.lotteryResult.id) {
          return item.id
        }
      })
      console.log(resultIndex, index)
      if (resultIndex === index) {
        console.log('抽奖结束')
        clearInterval(timer)
        
        // 输出结果
        setTimeout(() => {
          this.setData({ isStart: false })
          if (lotteryResult.price > 0) {
            this.setData({
              isResult: true,
              isBingo: true
            })
            this.addPrize()
          } else {
            this.setData({
              isResult: true,
              isBingo: false
            })
          }
        }, 1000)
        return
      }
    }
    
    if (timer) clearInterval(timer)
    timer = setInterval(() => {
      if (roundNum > 2) {
        // console.log('高速', index, roundNum)
        this.loop(index + 1, roundNum, speed)
      } else if (roundNum === 2) {
        // console.log('低速', index, roundNum)
        this.loop(index + 1, roundNum, 300)
      } else if (roundNum === 1) {
        // console.log('判断奖品', index, roundNum)
        this.loop(index + 1, roundNum, 500)
      }
    }, speed)
  },
  // 添加奖品到个人记录
  addPrize() {
    const { openid, avatar, nickname } = app.globalData.userInfo
    wx.showLoading({
      title: '加载中...',
      mask: true
    })
    obj.wxRequest({
      url: 'answerlotto/hitluck',
      data: {
        openid: openid,
        avatar: avatar,
        nickname: nickname,
        prize_id: this.data.lotteryResult.id
      }
    }).then(res => {
      wx.hideLoading()
      const { code, data } = res.data
      console.log(res.data)
      if (code > 0) {
        if (data) {
        
        }
      }
    })
  
  },
  // 跳转中奖名单
  toWinningList() {
    wx.navigateTo({
      url: '/packageteseE/pages/jiaxing_qa/winning-list/index'
    })
  },
  // 跳转到中奖记录
  toWinningRecord() {
    wx.navigateTo({
      url: '/packageteseE/pages/jiaxing_qa/winning-record/index'
    })
  },
  // 关闭
  handleClickClose() {
    this.setData({
      isResult: false
    })
  },
  // 继续抽奖
  handleContinueLottery() {
    this.setData({
      isResult: false
    })
    this.handleClickStartLottery()
  }
})
```

> index.wxml

```html
<!--packageteseE/pages/jiaxing_qa/start-lottery/index.wxml-->
<view class="main w-100 h-100 d-flex flex-column align-items-center">
  <view class="w-100">
    <image class="logo" mode="aspectFit" src="https://swzfw1.jiaxing.gov.cn/upload/answerlotto/logo_start_lottery.png"></image>
  </view>
  <view class="w-100">
    <view bind:tap="toWinningList" class="notice d-flex flex-row flex-nowrap align-items-center justify-content-between">
      <view class="d-flex flex-row flex-nowrap align-items-center">
        <image class="notice_icon" mode="aspectFit" src="https://swzfw1.jiaxing.gov.cn/upload/answerlotto/laba.png"></image>
        <text class="notice_tip text-overflow-ellipsis">恭喜{{winningName}}：抽中{{winningPrize}}</text>
      </view>
      <view class="notice_right_arrow_icon d-flex">
        <image class="notice_right_arrow_icon" mode="aspectFit" src="https://swzfw1.jiaxing.gov.cn/upload/answerlotto/right_arrow.png"></image>
      </view>
    </view>
  </view>
  <view class="container w-100 h-100">
    <view class="container_box">
      <view class="container_box_gird" style="background-color: {{dataList[0].isSelected? '#ff0000': '#ffab61'}}" id="{{dataList[0].id}}">
        <view class="grid_box d-flex flex-column align-items-center justify-content-end">
          <view class="grid_image">
            <image mode="aspectFit" src="{{dataList[0].prize_image}}"></image>
          </view>
          <view class="grid_text">{{dataList[0].short_name}}</view>
        </view>
      </view>
      <view class="container_box_gird" style="background-color: {{dataList[1].isSelected? '#ff0000': '#ffab61'}}" id="{{dataList[1].id}}">
        <view class="grid_box d-flex flex-column align-items-center justify-content-end">
          <view class="grid_image">
            <image mode="aspectFit" src="{{dataList[1].prize_image}}"></image>
          </view>
          <view class="grid_text">{{dataList[1].short_name}}</view>
        </view>
      </view>
      <view class="container_box_gird" style="background-color: {{dataList[2].isSelected? '#ff0000': '#ffab61'}}" id="{{dataList[2].id}}">
        <view class="grid_box d-flex flex-column align-items-center justify-content-end">
          <view class="grid_image">
            <image mode="aspectFit" src="{{dataList[2].prize_image}}"></image>
          </view>
          <view class="grid_text">{{dataList[2].short_name}}</view>
        </view>
      </view>
      <view class="container_box_gird" style="background-color: {{dataList[7].isSelected? '#ff0000': '#ffab61'}}" id="{{dataList[7].id}}">
        <view class="grid_box d-flex flex-column align-items-center justify-content-end">
          <view class="grid_image">
            <image mode="aspectFit" src="{{dataList[7].prize_image}}"></image>
          </view>
          <view class="grid_text">{{dataList[7].short_name}}</view>
        </view>
      </view>
      <view class="container_box_btn d-flex align-items-center justify-content-center">
        <view bind:tap="handleClickStartLottery" class="{{isStart? 'disable': ''}} grid_btn d-flex flex-nowrap align-items-center justify-content-center">
          <view>立即抽奖</view>
        </view>
      </view>
      <view class="container_box_gird" style="background-color: {{dataList[3].isSelected? '#ff0000': '#ffab61'}}" id="{{dataList[3].id}}">
        <view class="grid_box d-flex flex-column align-items-center justify-content-end">
          <view class="grid_image">
            <image mode="aspectFit" src="{{dataList[3].prize_image}}"></image>
          </view>
          <view class="grid_text">{{dataList[3].short_name}}</view>
        </view>
      </view>
      <view class="container_box_gird" style="background-color: {{dataList[6].isSelected? '#ff0000': '#ffab61'}}" id="{{dataList[6].id}}">
        <view class="grid_box d-flex flex-column align-items-center justify-content-end">
          <view class="grid_image">
            <image mode="aspectFit" src="{{dataList[6].prize_image}}"></image>
          </view>
          <view class="grid_text">{{dataList[6].short_name}}</view>
        </view>
      </view>
      <view class="container_box_gird" style="background-color: {{dataList[5].isSelected? '#ff0000': '#ffab61'}}" id="{{dataList[5].id}}">
        <view class="grid_box d-flex flex-column align-items-center justify-content-end">
          <view class="grid_image">
            <image mode="aspectFit" src="{{dataList[5].prize_image}}"></image>
          </view>
          <view class="grid_text">{{dataList[5].short_name}}</view>
        </view>
      </view>
      <view class="container_box_gird" style="background-color: {{dataList[4].isSelected? '#ff0000': '#ffab61'}}" id="{{dataList[4].id}}">
        <view class="grid_box d-flex flex-column align-items-center justify-content-end">
          <view class="grid_image">
            <image mode="aspectFit" src="{{dataList[4].prize_image}}"></image>
          </view>
          <view class="grid_text">{{dataList[4].short_name}}</view>
        </view>
      </view>
    </view>
    <view class="chance">
      还剩
      <text>{{chanceCount}}</text>
      次机会
    </view>
  </view>
</view>
<!--抽奖结果-->
<view wx:if="{{isResult}}" class="dialog d-flex flex-column align-items-center justify-content-center">
  <view wx:if="{{isBingo}}" class="dialog_bg winning_bg" style="background-image: url('https://swzfw1.jiaxing.gov.cn/upload/answerlotto/lottery_success.png');">
    <view class="w-100 h-100 d-flex flex-column align-items-center justify-content-end">
      <view class="winning_title">恭喜你 中奖啦</view>
      <view class="winning_box d-flex flex-row flex-nowrap align-items-center">
        <view class="winning_image" style="background: #3081f2;">
          <image class="winning_image" mode="aspectFit" src="{{lotteryResult.prize_image}}"></image>
        </view>
        <view class="d-flex flex-column" style="margin-left: 23rpx; font-weight: bold;">
          <view class="text-overflow-row-ellipsis" style="font-size: 24rpx; color: #333333;">{{lotteryResult.prize_name}}</view>
          <view style="font-size: 30rpx; color: #3081F2;">1{{lotteryResult.unit}}</view>
        </view>
      </view>
      <view class="winning_tip">奖品将在1小时内到账</view>
      <view bind:tap="toWinningRecord" class="winning_btn">查看</view>
    </view>
  </view>
  <view wx:else class="dialog_bg fail_bg" style="background-image: url('https://swzfw1.jiaxing.gov.cn/upload/answerlotto/lottery_fail.png');">
    <view class="w-100 h-100 d-flex flex-column align-items-center justify-content-end">
      <view bind:tap="handleContinueLottery" class="fail_btn">继续抽奖</view>
    </view>
  </view>
  <view class="close close_box">
    <image bind:tap="handleClickClose" class="close" mode="aspectFit" src="https://swzfw1.jiaxing.gov.cn/upload/answerlotto/close.png"></image>
  </view>
</view>

```

> index.wxss

```css
/* packageteseE/pages/jiaxing_qa/start-lottery/index.wxss */
@import "../../../../utils/css/common.wxss";

.main {
  background: url('https://swzfw1.jiaxing.gov.cn/upload/answerlotto/bg_nan.png') center center no-repeat;
  background-size: cover;
  padding: 233rpx 45rpx 30rpx;
}

.logo {
  width: 398rpx;
  height: 81rpx;
}

.notice {
  width: 550rpx;
  height: 60rpx;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 30rpx;
  margin-top: 141rpx;
  padding: 17rpx 30rpx 17rpx 18rpx;
}

.notice_icon {
  width: 35rpx;
  height: 26rpx;
}

.notice_tip {
  width: 420rpx;
  font-size: 22rpx;
  font-weight: 400;
  color: #ffffff;
  margin-left: 27rpx;
}

.notice_right_arrow_icon {
  width: 10rpx;
  height: 19rpx;
}

.container {
  width: 661rpx;
  height: 698rpx;
  border-radius: 20rpx;
  padding: 60rpx 60rpx 0 60rpx;
  margin-top: 53rpx;
  background: url("https://swzfw1.jiaxing.gov.cn/upload/answerlotto/bg_lottery.png") center center no-repeat;
  background-size: cover;
  text-align: center;
}

.container_box {
  width: 537rpx;
  height: 537rpx;
  display: grid;
  grid-template-columns: 174rpx 174rpx 174rpx;
  grid-template-rows: 174rpx 174rpx 174rpx;
  grid-row-gap: 8rpx;
  grid-column-gap: 8rpx;
  margin-bottom: 39rpx;
}

.container_box_gird {
  border-radius: 10rpx;
  width: 174rpx;
  height: 174rpx;
  padding: 8rpx;
}

.container_box_btn {
  width: 174rpx;
  height: 174rpx;
  z-index: 9;
}

.grid_box {
  width: 100%;
  height: 100%;
  background: #ffe9c6;
  border-radius: 10rpx;
  padding-bottom: 22rpx;
}

.grid_image {
  width: 100rpx;
  height: 100rpx;
}

.grid_text {
  font-size: 22rpx;
  font-weight: bold;
  color: #b61320;
}

.grid_btn {
  width: 168rpx;
  height: 168rpx;
  background: #ffdf47;
  border-radius: 33rpx;
}

.disable {
  opacity: 0.7;
}

.grid_btn > view {
  width: 100rpx;
  height: auto;
  font-size: 48rpx;
  font-weight: bold;
  color: #b1000f;
  line-height: 50rpx;
}

.chance {
  font-size: 28rpx;
  font-weight: normal;
  color: #ffe9c6;
}

.chance > text {
  color: #ff8903;
}

/*弹窗*/
.dialog {
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  z-index: 999;
}

.dialog_bg {
  background-position: center center;
  background-size: cover;
  background-repeat: no-repeat;
}

.close_box {
  margin-top: 33rpx;
}

.close_box:active {
  opacity: 0.7;
}

.close {
  width: 55rpx;
  height: 55rpx;
}

/*中奖成功样式*/
.winning_bg {
  width: 641.4rpx;
  height: 758.9rpx;
}


.winning_title {
  font-size: 36rpx;
  font-weight: bold;
  color: #ffffff;
}

.winning_box {
  width: 358rpx;
  background-color: #ffffff;
  border-radius: 10rpx;
  margin: 30rpx 0;
  padding: 9rpx 6rpx;
}

.winning_image {
  width: 101rpx;
  height: 106rpx;
  border-radius: 10rpx;
}

.winning_tip {
  font-size: 22rpx;
  font-weight: bold;
  color: #ffd121;
  line-height: 31rpx;
  margin-bottom: 23rpx;
}

.winning_btn {
  width: 233rpx;
  height: 65rpx;
  background: url("https://swzfw1.jiaxing.gov.cn/upload/answerlotto/view.png") center center no-repeat;
  background-size: cover;
  font-size: 27rpx;
  font-weight: bold;
  color: #8d5a00;
  line-height: 65rpx;
  text-align: center;
  margin-bottom: 51rpx;
}

.winning_btn:active {
  opacity: 0.7;
}

/*中奖失败样式*/
.fail_bg {
  width: 456rpx;
  height: 520rpx;
}

.fail_btn {
  width: 233rpx;
  height: 65rpx;
  background: linear-gradient(178deg, #fdf8f5, #cecbff, #fcfbef);
  border-radius: 33rpx;
  font-size: 27rpx;
  font-weight: bold;
  color: #443ea4;
  line-height: 65rpx;
  text-align: center;
  margin-bottom: 52rpx;
}

.fail_btn:active {
  opacity: 0.7;
}

/*兑换奖品*/
.header_bg {
  width: 576rpx;
  height: 299.9rpx;
  background: url("https://swzfw1.jiaxing.gov.cn/upload/answerlotto/userinfo.png") center center no-repeat;
  background-size: cover;
}

.form_box {
  width: 576rpx;
  height: 430rpx;
  background-color: #ffffff;
  border-bottom-left-radius: 20rpx;
  border-bottom-right-radius: 20rpx;
  padding: 0 48rpx;
}

.form_box:first-child {
  margin-top: 0;
}

.form_control {
  border-bottom: 1rpx solid #dcdcdc;
  padding-bottom: 15rpx;
  padding-left: 17rpx;
  height: 89rpx;
  margin-top: 10rpx;
}

.form_label {
  font-size: 28rpx;
  font-weight: 500;
  color: #333333;
}

.form_input {
  font-size: 20rpx;
  font-weight: 500;
  color: #333333;
  outline: none;
  padding: 0 30rpx;
  flex: 1;
}

.submit_btn {
  width: 350rpx;
  height: 70rpx;
  background: #4671f3;
  border-radius: 35rpx;
  font-size: 32rpx;
  font-weight: 500;
  color: #FFFFFF;
  line-height: 70rpx;
  text-align: center;
}
```

